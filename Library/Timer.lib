#include <mega32.h>
#include <Timer.h>
#include <Tirax.h>
#include <stdlib.h>

unsigned char TimerN=0;
unsigned char TimerBitSize=0;

char *tflag;//Timer Flag Register
char *treserved; //Timer is Reserved
void(**tfunc)();// Timer Functions Addresses

unsigned int *tj;//Job Time
unsigned int *tt;//Timer Time

void StartTimer(unsigned char i,unsigned int t, void(*f)() ){
	setBitCharArr(treserved,i);
	tfunc[i]=f;
	tt[i]=t;
	tj[i]=0;//i:Timer Number,t:Timer time,f: Function
} 
void StartJob(unsigned char i,unsigned int t, void(*f)() ){
	setBitCharArr(treserved,i);
	tfunc[i]=f;
	tt[i]=t;
	tj[i]=t;
} 
void StopTimer(unsigned char i){
	resetBitCharArr(treserved,i);
	tt[i]=0;
	tj[i]=0;
}
unsigned char StartNextTimer(unsigned int t, void(*f)() ){
    unsigned char i;
    i=findFreeTimer();
    StartTimer(i,t,f);
    return i;
}
unsigned char StartNextJob(unsigned int t, void(*f)() ){
    unsigned char i;
    i=findFreeTimer();
    StartJob(i,t,f);
    return i;
}
unsigned char findFreeTimer(){
	unsigned char i;
	for(i=1;i<TimerN;i++){
		if (readBitCharArr(treserved,i)==0){
			return i;
		}
	}
}

//Run all timer functions
void RunTimer(){
    unsigned char i;
    for (i=0;i<TimerN;i++){
        if (READF(i)==1){
            tfunc[i]();
            RESETF(i);
            return;
        } 
    }
}

//Initialize ATmega32 Timer Registers
void initTimer(unsigned char size){
	size++;
	TimerN=size;
	TimerBitSize=size/8+(size%8!=0);
	tj = (unsigned int *) calloc(size,sizeof(unsigned int)); 
    tt = (unsigned int *) calloc(size,sizeof(unsigned int));
	tflag = (char *) calloc(TimerBitSize,sizeof(char));
	treserved = (char *) calloc(TimerBitSize,sizeof(char));
	tfunc = (void(**)()) calloc(size,sizeof( void(*)() ));
	
    TCCR0=(0<<WGM00) | (0<<COM01) | (0<<COM00) | (0<<WGM01) | (0<<CS02) | (1<<CS01) | (1<<CS00);
    TCNT0=0x83;
    OCR0=0x00;
    TIMSK=TIMSK | (1<<TOIE0); 
}

interrupt [TIM0_OVF] void timer0_ovf_isr(void)
{
    unsigned char i;    
    TCNT0=0x83;
    for (i=0;i<TimerN;i++){
        if (tt[i]>1){
            tt[i]--;      
        }else if(tt[i]==1){
            tt[i]--;
            tt[i]=tj[i];
            SETF(i);
        }
    }  
}