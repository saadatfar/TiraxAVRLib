
void spi_send(unsigned char addr,char data)
{
	  spi(addr);
      spi(data);
      Load = 1;
      delay_us(100);
      Load = 0;
}

void max7219_init(void)
{
	// SPI initialization
	// SPI Type: Master
	// SPI Clock Rate: 500/000 kHz
	// SPI Clock Phase: Cycle Start
	// SPI Clock Polarity: Low
	// SPI Data Order: MSB First
	SPCR=(0<<SPIE) | (1<<SPE) | (0<<DORD) | (1<<MSTR) | (0<<CPOL) | (0<<CPHA) | (0<<SPR1) | (1<<SPR0);
	SPSR=(0<<SPI2X);
	delay_ms(100);
	Load = 1;
	delay_us(100);
	Load = 0;
	spi_send(SDR,Normal);
	spi_send(DMR,NoDecode);
	spi_send(IR,INTENSITY(100));
	spi_send(SLR,DIGIT_DISPLAY(8));
	spi_send(DMR,NoDecode);
}
char numbers[] = {
	0b01111110, //0
	0b00110000, //1
	0b01101101, //2
	0b01111001, //3
	0b00110011, //4
	0b01011111, //5
	0b01011111, //6
	0b01110000, //7
	0b01111111, //8
	0b01111011, //9
	0b00000001, //-
	0b00000000, //Blank
}

void max7219_rotate( char in[8], char out[8])
{
	int i,j;
	for(i=0;i<8;i++)
	{
		out(i) = 0;
		for(j=0;j<8;j++)
		{
			out(i) = out(i) + (((in(j)&(1<<i))>>i)<<j);
		}
	}
}
void max7219_display(int *in) // for Common Anode
{
	int i;
	char rotatedDisp[8];
	char disp[8];
	for (i=0;i<8;i++)
	{
		disp[i] = numbers[in[i]];
	}
	max7219_rotate(prevDisp,disp);
	for(i=0;i<8;i++)
		spi_send(DR(i),rotateDisp[i]);
}
